name: Sync Upstream (Reusable)

on:
  workflow_call:
    inputs:
      upstream_owner:
        description: 'Owner of the upstream repository'
        required: true
        type: string
      upstream_repo:
        description: 'Name of the upstream repository'
        required: true
        type: string
      default_branch:
        description: 'Default branch of the upstream repository'
        required: true
        type: string
      force:
        description: 'Force sync even if already up to date'
        required: false
        type: boolean
        default: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      pr_created: ${{ steps.create-pr.outputs.pr_created }}
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      in_sync: ${{ steps.compare.outputs.in_sync }}
      merge_success: ${{ steps.merge.outputs.merge_success }}
    steps:
      - name: Checkout fork
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          ref: upstream-tracking

      - name: Add upstream remote
        run: git remote add upstream https://github.com/${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }}.git

      - name: Fetch upstream default branch
        run: git fetch upstream ${{ inputs.default_branch }}

      - name: Verify upstream repo identity
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -f FORK_MANIFEST.json ]; then
            EXPECTED_ID=$(jq -r '.upstream.repo_id // empty' FORK_MANIFEST.json)
            if [ -n "${EXPECTED_ID}" ]; then
              ACTUAL_ID=$(gh api "repos/${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }}" --jq '.id' 2>/dev/null || echo "")
              if [ -z "${ACTUAL_ID}" ]; then
                echo "::error::Upstream repo ${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }} is no longer accessible."
                exit 1
              elif [ "${ACTUAL_ID}" != "${EXPECTED_ID}" ]; then
                echo "::error::SECURITY ALERT: Upstream repo ID changed from ${EXPECTED_ID} to ${ACTUAL_ID}."
                echo "::error::This may indicate the repository was deleted and re-created (name squatting attack)."
                exit 1
              else
                echo "Upstream repo identity verified (ID: ${ACTUAL_ID})"
              fi
            else
              echo "No repo_id in manifest, skipping identity check."
            fi
          fi

      - name: Compare SHAs
        id: compare
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          UPSTREAM_SHA=$(git rev-parse upstream/${{ inputs.default_branch }})
          echo "current_sha=${CURRENT_SHA}" >> "$GITHUB_OUTPUT"
          echo "upstream_sha=${UPSTREAM_SHA}" >> "$GITHUB_OUTPUT"

          if [ "${CURRENT_SHA}" = "${UPSTREAM_SHA}" ] && [ "${{ inputs.force }}" != "true" ]; then
            echo "Already in sync"
            echo "in_sync=true" >> "$GITHUB_OUTPUT"
          else
            echo "Updates available: ${CURRENT_SHA} -> ${UPSTREAM_SHA}"
            echo "in_sync=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Exit early if in sync
        if: steps.compare.outputs.in_sync == 'true'
        run: |
          echo "Fork is already in sync with upstream. Nothing to do."
          exit 0

      - name: Attempt fast-forward merge
        if: steps.compare.outputs.in_sync == 'false'
        id: merge
        run: |
          if git merge --ff-only upstream/${{ inputs.default_branch }}; then
            echo "merge_success=true" >> "$GITHUB_OUTPUT"
          else
            echo "merge_success=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Open divergence issue on merge failure
        if: steps.compare.outputs.in_sync == 'false' && steps.merge.outputs.merge_success == 'false'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[Action Required] Upstream divergence detected',
              labels: ['upstream-sync', 'needs-security-review'],
              body: [
                '## Upstream Divergence Detected',
                '',
                'The `upstream-tracking` branch has diverged from `${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }}@${{ inputs.default_branch }}` and cannot be fast-forward merged.',
                '',
                '> **Security Note:** A non-fast-forward divergence may indicate that the upstream repository had its history rewritten (force-push). This is unusual for maintained projects and should be investigated before resolving.',
                '',
                '### Investigation Steps',
                '',
                '1. Check if the upstream repo was recently transferred, renamed, or recreated.',
                '2. Review the upstream commit history for signs of force-push or rebase.',
                '3. Compare the `FORK_MANIFEST.json` `repo_id` against the current upstream repo ID.',
                '',
                '### Manual Resolution Steps',
                '',
                '1. Fetch the upstream changes locally:',
                '   ```bash',
                '   git remote add upstream https://github.com/${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }}.git',
                '   git fetch upstream ${{ inputs.default_branch }}',
                '   ```',
                '2. Check out the `upstream-tracking` branch:',
                '   ```bash',
                '   git checkout upstream-tracking',
                '   ```',
                '3. Rebase or merge manually:',
                '   ```bash',
                '   git rebase upstream/${{ inputs.default_branch }}',
                '   ```',
                '4. Resolve any conflicts and push:',
                '   ```bash',
                '   git push origin upstream-tracking',
                '   ```',
              ].join('\n')
            });

      - name: Fail workflow on divergence
        if: steps.compare.outputs.in_sync == 'false' && steps.merge.outputs.merge_success == 'false'
        run: |
          echo "::error::Upstream divergence detected. Fast-forward merge failed."
          exit 1

      - name: Update FORK_MANIFEST.json
        if: steps.compare.outputs.in_sync == 'false' && steps.merge.outputs.merge_success == 'true'
        id: manifest
        run: |
          if [ -f FORK_MANIFEST.json ]; then
            jq \
              --arg sha "${{ steps.compare.outputs.upstream_sha }}" \
              --arg date "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              '.sync.last_synced_sha = $sha | .sync.last_synced_date = $date' \
              FORK_MANIFEST.json > FORK_MANIFEST.json.tmp \
              && mv FORK_MANIFEST.json.tmp FORK_MANIFEST.json
            echo "updated=true" >> "$GITHUB_OUTPUT"
          else
            echo "FORK_MANIFEST.json not found on upstream-tracking branch, skipping manifest update."
            echo "updated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit manifest update
        if: steps.manifest.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add FORK_MANIFEST.json
          if git diff --cached --quiet; then
            echo "No manifest changes to commit."
          else
            git commit -m "chore: update sync manifest"
          fi

      - name: Push upstream-tracking
        if: steps.compare.outputs.in_sync == 'false' && steps.merge.outputs.merge_success == 'true'
        run: git push origin upstream-tracking

      - name: Generate diff stats
        if: steps.compare.outputs.in_sync == 'false' && steps.merge.outputs.merge_success == 'true'
        id: diff
        run: |
          DIFF_STATS=$(git diff --stat origin/${{ inputs.default_branch }}...HEAD)
          echo "diff_stats<<EOF" >> "$GITHUB_OUTPUT"
          echo "${DIFF_STATS}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Check for security-relevant changes
        if: steps.compare.outputs.in_sync == 'false' && steps.merge.outputs.merge_success == 'true'
        id: security
        run: |
          SECURITY_FILES=$(git diff --name-only origin/${{ inputs.default_branch }}...HEAD -- \
            'action.yml' \
            'action.yaml' \
            'Dockerfile' \
            'package.json' \
            'package-lock.json' \
            '*.ps1' \
            '*.sh' \
            'dist/' \
            'node_modules/' \
          || true)

          if [ -n "${SECURITY_FILES}" ]; then
            echo "has_security_changes=true" >> "$GITHUB_OUTPUT"
            echo "security_files<<EOF" >> "$GITHUB_OUTPUT"
            echo "${SECURITY_FILES}" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "has_security_changes=false" >> "$GITHUB_OUTPUT"
            echo "security_files=None detected" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request
        if: steps.compare.outputs.in_sync == 'false' && steps.merge.outputs.merge_success == 'true'
        id: create-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING_PR=$(gh pr list \
            --repo "${{ github.repository }}" \
            --base ${{ inputs.default_branch }} \
            --head upstream-tracking \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "${EXISTING_PR}" ]; then
            echo "Sync PR already exists (#${EXISTING_PR}), skipping creation."
            echo "pr_created=true" >> "$GITHUB_OUTPUT"
            echo "pr_number=${EXISTING_PR}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          cat > /tmp/pr_body.md << 'PR_BODY'
          ## Upstream Sync

          Syncing changes from [`${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }}@${{ inputs.default_branch }}`](https://github.com/${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }}).

          ### Diff Stats

          ```
          ${{ steps.diff.outputs.diff_stats }}
          ```

          ### Security-Relevant Files

          ```
          ${{ steps.security.outputs.security_files }}
          ```

          ### Upstream Comparison

          [`${{ steps.compare.outputs.current_sha }}...${{ steps.compare.outputs.upstream_sha }}`](https://github.com/${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }}/compare/${{ steps.compare.outputs.current_sha }}...${{ steps.compare.outputs.upstream_sha }})

          ### Review Checklist

          - [ ] Check `action.yml` / `action.yaml` for unexpected changes
          - [ ] Check for new or modified dependencies
          - [ ] Check for obfuscated or minified code changes
          - [ ] Run security scan on changed files
          - [ ] Verify no secrets or credentials exposed
          PR_BODY

          sed -i 's/^          //' /tmp/pr_body.md

          PR_URL=$(gh pr create \
            --repo "${{ github.repository }}" \
            --base ${{ inputs.default_branch }} \
            --head upstream-tracking \
            --title "chore: sync upstream ${{ inputs.upstream_owner }}/${{ inputs.upstream_repo }}" \
            --label "upstream-sync" \
            --label "needs-security-review" \
            --body-file /tmp/pr_body.md)

          PR_NUM=$(echo "${PR_URL}" | grep -oE '[0-9]+$')
          echo "pr_created=true" >> "$GITHUB_OUTPUT"
          echo "pr_number=${PR_NUM}" >> "$GITHUB_OUTPUT"
          echo "Created PR #${PR_NUM}"
